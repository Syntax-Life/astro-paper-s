---
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
// import Breadcrumb from "@/components/Breadcrumb.astro";
import Layout from "./Layout.astro";
import { SITE } from "@/config";
import { getBlogMetrics } from "@/utils/getBlogMetrics";

export interface Props {
  frontmatter: {
    title: string;
    description?: string;
  };
}

const { frontmatter } = Astro.props;
const blogStats = await getBlogMetrics();
---

<Layout title={`${frontmatter.title} | ${SITE.title}`}>
  <Header />
  <!-- <Breadcrumb /> -->
  <main id="main-content">
    <section id="about" class="prose mb-28 max-w-3xl prose-img:border-0">
      <h1 class="mt-6 text-2xl tracking-wider sm:text-3xl">
        <!-- {frontmatter.title} -->
        <div id="blog-stats-data" 
           data-running-days={blogStats.runningDays}
           data-total-posts={blogStats.totalPosts}
           data-total-words={blogStats.totalWordsInWan}
           data-start-year="2018"
           data-start-month="8"
           data-start-day="31"
           style="display: none;">
        </div>
      </h1>
      <slot />
    </section>
  </main>
  <Footer />
</Layout>

<script>
  function animateNumber(element: HTMLElement, targetValue: number, duration: number = 2000, isDecimal: boolean = false) {
    const startValue = 0;
    const startTime = performance.now();
    
    function updateNumber(currentTime: number) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      
      const easeOutQuart = 1 - Math.pow(1 - progress, 4);
      const currentValue = startValue + (targetValue - startValue) * easeOutQuart;
      
      if (isDecimal) {
        element.textContent = currentValue.toFixed(1);
      } else {
        element.textContent = Math.floor(currentValue).toString();
      }
      
      if (progress < 1) {
        requestAnimationFrame(updateNumber);
      } else {
        if (isDecimal) {
          element.textContent = targetValue.toFixed(1);
        } else {
          element.textContent = targetValue.toString();
        }
      }
    }
    
    requestAnimationFrame(updateNumber);
  }

  function startAnimations() {
    const statsData = document.getElementById('blog-stats-data');
    if (!statsData) return;
    
    const runningDays = parseInt(statsData.dataset.runningDays || '0');
    const totalPosts = parseInt(statsData.dataset.totalPosts || '0');
    const totalWords = parseFloat(statsData.dataset.totalWords || '0');
    const startYear = parseInt(statsData.dataset.startYear || '2018');
    const startMonth = parseInt(statsData.dataset.startMonth || '8');
    const startDay = parseInt(statsData.dataset.startDay || '31');
    
    const elements = [
      { id: 'start-year', value: startYear, duration: 1000 },
      { id: 'start-month', value: startMonth, duration: 800 },
      { id: 'start-day', value: startDay, duration: 600 },
      { id: 'running-days', value: runningDays, duration: 2000 },
      { id: 'total-posts', value: totalPosts, duration: 1500 },
      { id: 'total-words', value: totalWords, duration: 2500, isDecimal: true }
    ];
    
    elements.forEach((item, index) => {
      const element = document.getElementById(item.id);
      if (element) {
        setTimeout(() => {
          animateNumber(element, item.value, item.duration, item.isDecimal || false);
        }, index * 200);
      }
    });
  }

  // 渲染博客进程时间轴
  function renderTimeline() {
    const timeline = document.getElementById('blog-timeline');
    const dataEl = document.getElementById('blog-timeline-data');

    if (!timeline || !dataEl) return;
    if (timeline.dataset.initialized === 'true') return;

    try {
      const events = JSON.parse(dataEl.textContent || '[]');
      const frag = document.createDocumentFragment();

      events.forEach((evt: { date: string; text: string }) => {
        const item = document.createElement('div');
        item.className = 'relative pl-8';

        const marker = document.createElement('span');
        marker.className = 'absolute left-0 top-[6px] h-2 w-2 rounded-full bg-accent ring-2 ring-accent/30';

        const date = document.createElement('div');
        date.className = 'text-sm text-accent/85 font-medium';
        date.textContent = evt.date;

        const text = document.createElement('div');
        text.className = 'mt-1 leading-relaxed dark:text-foreground';
        text.textContent = evt.text;

        item.append(marker, date, text);
        frag.appendChild(item);
      });

      timeline.appendChild(frag);
      timeline.dataset.initialized = 'true';
    } catch (e) {
      /* 忽略渲染错误 */
    }
  }

  function initializeAnimations() {
    setTimeout(() => {
      startAnimations();
      renderTimeline();
    }, 300);
  }

  document.addEventListener('astro:page-load', () => {
    initializeAnimations();
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAnimations);
  } else {
    initializeAnimations();
  }
</script>